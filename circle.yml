machine:
  node:
    version: 6
  environment:
    NODE_ENV: test
    DROP_DATABASE: DROP DATABASE IF EXISTS lux_test;
    CREATE_DATABASE: CREATE DATABASE lux_test;
    DATABASE_USERNAME: ubuntu
database:
  override:
    - psql -c "$DROP_DATABASE" -U postgres
    - psql -c "$CREATE_DATABASE" -U postgres
    - mysql -e "$DROP_DATABASE"
    - mysql -e "$CREATE_DATABASE"
dependencies:
  pre:
    - |
      cd ../

      if [ -d watchman ]; then
        cd watchman
        sudo make install
      else
        git clone https://github.com/facebook/watchman.git
        cd watchman
        git checkout v4.7.0

        ./autogen.sh
        ./configure
        make
        sudo make install
      fi

      cd ../lux
  override:
    - curl -o- -L https://yarnpkg.com/install.sh | bash
    - yarn install
    - yarn link
  post:
    - |
      cd test/test-app
      yarn install
      cd ../../
  cache_directories:
    - /home/ubuntu/watchman
compile:
  pre:
    - yarn run clean
  override:
    - NODE_ENV=production yarn build
    - |
      cd test/test-app
      lux build -e test
      cd ../../
test:
  pre:
    - cd test/test-app && lux db:migrate -e test --skip-build && cd ../../:
        parallel: true
    - cd test/test-app && lux db:seed -e test --skip-build && cd ../../:
        parallel: true
  override:
    - yarn flow:
        parallel: true
    - yarn lint:
        parallel: true
    - yarn test -- -w='2':
        parallel: true
        environment:
          JEST_JUNIT_OUTPUT: $CIRCLE_TEST_REPORTS/junit/test-results.xml
  post:
    - yarn codecov:
        parallel: true
notify:
  webhooks:
    - url: https://webhooks.gitter.im/e/6d49c9b19c888dba70b8
deployment:
  release:
    tag: /^(?:v\d.\d.\d)$/
    commands:
      - yarn run clean
      - yarn build
      - rm -rf ~/.npmrc && touch ~/.npmrc
      - echo //registry.npmjs.org/:_authToken=$NPM_AUTH_TOKEN >> ~/.npmrc
      - yarn publish
